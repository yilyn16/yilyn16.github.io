(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{298:function(o,t,e){"use strict";e.r(t);var a=e(7),s=Object(a.a)({},(function(){var o=this,t=o._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":o.$parent.slotKey}},[t("h1",{attrs:{id:"一条数据是如何写入的"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一条数据是如何写入的"}},[o._v("#")]),o._v(" 一条数据是如何写入的")]),o._v(" "),t("p",[o._v("InnoDB作为使用最广的一款引擎，在众多引擎中对可靠性和高性能之间做了平衡，在事物控制、读写效率、并发、索引搜索等方面都有不错的表现。")]),o._v(" "),t("p",[o._v("InnoDB作为存储引擎，通过执行器对内存和磁盘中的数据进行写入和读取，本章主要看一下数据写入的过程。")]),o._v(" "),t("h2",{attrs:{id:"数据写入流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据写入流程"}},[o._v("#")]),o._v(" 数据写入流程")]),o._v(" "),t("p",[t("img",{attrs:{src:"/images/databases/%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B.png",alt:"数据写入流程"}})]),o._v(" "),t("ol",[t("li",[o._v("通过MySQL Server层的SQL接口和SQL解析器，将SQL解析为MySQL能够识别的语句，生成一个解析树；")]),o._v(" "),t("li",[o._v("然后SQL优化器会对这个SQL语句进行优化，生成执行计划，通过执行器传给InnoDB引擎；")]),o._v(" "),t("li",[o._v("开始执行后，首先为了让写入数据支持回滚操作，需要把旧的值记录到undo log文件中；")]),o._v(" "),t("li",[o._v("因为MySQL最终的数据都是存在磁盘中，但是每次写入如果都需要写入磁盘的话，效率就太低了，所以InnoDB将所有的写入请求都写到内存中的Buffer Pool中；")]),o._v(" "),t("li",[o._v("InnoDB 会有单独的IO线程将 Buffer Pool 中的数据读取出来，然后写入磁盘，这个写入磁盘的过程是通过操作系统的open+write函数写入磁盘的 .idb 文件；")]),o._v(" "),t("li",[o._v("如果刚写入Buffer Pool，MySQL服务宕机了，那么刚写入Buffer Pool的数据就丢了，如何解决这个问题，此时Redo Log就派上用场了")]),o._v(" "),t("li",[o._v("当数据写入Buffer Pool完成之后，在InnoDB引擎中将本次的数据请求写入Redo Log Buffer，再由Redo Log Buffer刷入磁盘文件中。")]),o._v(" "),t("li",[o._v("当Redo Log写入的同时，会进行Bin Log刷盘操作，刷盘成功后，告知Redo Log 事物已提交，并在Redo Log中打入commit标记，代表整个数据事物完成。")])]),o._v(" "),t("h2",{attrs:{id:"redo-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redo-log"}},[o._v("#")]),o._v(" Redo Log")]),o._v(" "),t("p",[o._v("Redo Log是InnoDB存储引擎特有的日志机制，借助内存的Redo Log Buffer和操作系统的Page Cache进行Redo Log的刷盘操作。")]),o._v(" "),t("h3",{attrs:{id:"刷盘策略"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#刷盘策略"}},[o._v("#")]),o._v(" 刷盘策略")]),o._v(" "),t("div",{staticClass:"language-SQL line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[o._v("-- 查看刷盘策略")]),o._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[o._v("show")]),o._v(" variables "),t("span",{pre:!0,attrs:{class:"token operator"}},[o._v("like")]),o._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[o._v("'innodb_flush_log_at_trx_commit'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[o._v(";")]),o._v("\n")])]),o._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[o._v("1")]),t("br"),t("span",{staticClass:"line-number"},[o._v("2")]),t("br")])]),t("p",[o._v("InnoDB的Redo Log刷盘策略有3种，代表了将Redo Log Buffer内存中的数据刷入磁盘的频率")]),o._v(" "),t("ol",[t("li",[t("strong",[o._v("innodb_flush_log_at_trx_commit=0")]),o._v("：每次提交事务都不刷盘，而是由一个后台线程每隔1s进行1次数据写入Page Cache和刷盘操作，这种策略仍然有数据丢失的风险")]),o._v(" "),t("li",[t("strong",[o._v("innodb_flush_log_at_trx_commit=1")]),o._v("：是默认的刷盘策略，每次提交事务都将本次记录在Redo Log Buffer中的数据写入操作系统的Page Cache中，并立刻进行刷盘操作，这种方式可以保证数据一致性。")]),o._v(" "),t("li",[t("strong",[o._v("innodb_flush_log_at_trx_commit=2")]),o._v("：每次事务提交之后都把数据从Redo Log Buffer写入操作系统的Page Cache中，由操作系统决定什么时候写入磁盘。如果出现断电或者整个服务器宕机，也会有数据丢失的问题。")])]),o._v(" "),t("h2",{attrs:{id:"bin-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#bin-log"}},[o._v("#")]),o._v(" Bin Log")]),o._v(" "),t("p",[o._v("变更历史查询、数据恢复和备份、主从复制")])])}),[],!1,null,null,null);t.default=s.exports}}]);