<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis | yilyn</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/images/logo.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.2cc3792c.css" as="style"><link rel="preload" href="/assets/js/app.550bb993.js" as="script"><link rel="preload" href="/assets/js/2.90409a71.js" as="script"><link rel="preload" href="/assets/js/16.4c8c8826.js" as="script"><link rel="prefetch" href="/assets/js/10.6a1a6c22.js"><link rel="prefetch" href="/assets/js/11.e1beb506.js"><link rel="prefetch" href="/assets/js/12.345d4694.js"><link rel="prefetch" href="/assets/js/13.aa99c9b1.js"><link rel="prefetch" href="/assets/js/14.2e6aae74.js"><link rel="prefetch" href="/assets/js/15.e60da1cd.js"><link rel="prefetch" href="/assets/js/17.0a5ea4b2.js"><link rel="prefetch" href="/assets/js/18.4ef3ca88.js"><link rel="prefetch" href="/assets/js/19.ed5b67c2.js"><link rel="prefetch" href="/assets/js/20.64d80033.js"><link rel="prefetch" href="/assets/js/21.e2d4fbf9.js"><link rel="prefetch" href="/assets/js/22.2e95842d.js"><link rel="prefetch" href="/assets/js/23.14aca209.js"><link rel="prefetch" href="/assets/js/24.43ca896f.js"><link rel="prefetch" href="/assets/js/25.c4535bf6.js"><link rel="prefetch" href="/assets/js/26.c8e8879b.js"><link rel="prefetch" href="/assets/js/27.03c9845f.js"><link rel="prefetch" href="/assets/js/28.88dcb212.js"><link rel="prefetch" href="/assets/js/29.863d604c.js"><link rel="prefetch" href="/assets/js/3.94daacd8.js"><link rel="prefetch" href="/assets/js/30.2084e635.js"><link rel="prefetch" href="/assets/js/31.2ab7f713.js"><link rel="prefetch" href="/assets/js/32.a27dfddd.js"><link rel="prefetch" href="/assets/js/33.c6549401.js"><link rel="prefetch" href="/assets/js/34.06a65af4.js"><link rel="prefetch" href="/assets/js/35.72e623d6.js"><link rel="prefetch" href="/assets/js/36.a7297bce.js"><link rel="prefetch" href="/assets/js/37.9737dca1.js"><link rel="prefetch" href="/assets/js/38.82978130.js"><link rel="prefetch" href="/assets/js/39.fd78df27.js"><link rel="prefetch" href="/assets/js/4.928945bf.js"><link rel="prefetch" href="/assets/js/40.61a1a6ab.js"><link rel="prefetch" href="/assets/js/41.1f086cc5.js"><link rel="prefetch" href="/assets/js/42.bf3ad2c6.js"><link rel="prefetch" href="/assets/js/43.16c54e3d.js"><link rel="prefetch" href="/assets/js/44.33a449ad.js"><link rel="prefetch" href="/assets/js/45.640d491e.js"><link rel="prefetch" href="/assets/js/46.bfd0c1dc.js"><link rel="prefetch" href="/assets/js/47.1657721e.js"><link rel="prefetch" href="/assets/js/48.bdde6d65.js"><link rel="prefetch" href="/assets/js/5.aaf9222d.js"><link rel="prefetch" href="/assets/js/6.77bf1753.js"><link rel="prefetch" href="/assets/js/7.77cf701d.js"><link rel="prefetch" href="/assets/js/8.254f569f.js"><link rel="prefetch" href="/assets/js/9.b33c928a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2cc3792c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="yilyn" class="logo"> <span class="site-name can-hide">yilyn</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JAVA基础" class="dropdown-title"><span class="title">JAVA基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="JAVA基础" class="mobile-dropdown-title"><span class="title">JAVA基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java_basics/collections/" class="nav-link">
  集合类
</a></li><li class="dropdown-item"><!----> <a href="/java_basics/multi_threads/" class="nav-link">
  多线程
</a></li><li class="dropdown-item"><!----> <a href="/java_basics/JUC/" class="nav-link">
  JUC
</a></li><li class="dropdown-item"><!----> <a href="/java_basics/jvm/" class="nav-link">
  JVM
</a></li><li class="dropdown-item"><!----> <a href="/java_basics/algorithm/" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow down"></span></button> <button type="button" aria-label="中间件" class="mobile-dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/middleware/kafka/" class="nav-link">
  Kafka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="网络" class="dropdown-title"><span class="title">网络</span> <span class="arrow down"></span></button> <button type="button" aria-label="网络" class="mobile-dropdown-title"><span class="title">网络</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/network/netty/" class="nav-link">
  netty
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/big_data/flink-cdc/" class="nav-link">
  Flink CDC
</a></li><li class="dropdown-item"><!----> <a href="/big_data/hadoop/" class="nav-link">
  Hadoop
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/databases/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/databases/redis/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="环境搭建" class="dropdown-title"><span class="title">环境搭建</span> <span class="arrow down"></span></button> <button type="button" aria-label="环境搭建" class="mobile-dropdown-title"><span class="title">环境搭建</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/env_build/blog_vuepress/" class="nav-link">
  博客by-vuepress
</a></li><li class="dropdown-item"><!----> <a href="/env_build/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/env_build/linux/" class="nav-link">
  linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="记录" class="dropdown-title"><span class="title">记录</span> <span class="arrow down"></span></button> <button type="button" aria-label="记录" class="mobile-dropdown-title"><span class="title">记录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/take_notes/interview/" class="nav-link">
  面试
</a></li><li class="dropdown-item"><!----> <a href="/take_notes/essay/" class="nav-link">
  优秀文章
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JAVA基础" class="dropdown-title"><span class="title">JAVA基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="JAVA基础" class="mobile-dropdown-title"><span class="title">JAVA基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java_basics/collections/" class="nav-link">
  集合类
</a></li><li class="dropdown-item"><!----> <a href="/java_basics/multi_threads/" class="nav-link">
  多线程
</a></li><li class="dropdown-item"><!----> <a href="/java_basics/JUC/" class="nav-link">
  JUC
</a></li><li class="dropdown-item"><!----> <a href="/java_basics/jvm/" class="nav-link">
  JVM
</a></li><li class="dropdown-item"><!----> <a href="/java_basics/algorithm/" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow down"></span></button> <button type="button" aria-label="中间件" class="mobile-dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/middleware/kafka/" class="nav-link">
  Kafka
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="网络" class="dropdown-title"><span class="title">网络</span> <span class="arrow down"></span></button> <button type="button" aria-label="网络" class="mobile-dropdown-title"><span class="title">网络</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/network/netty/" class="nav-link">
  netty
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/big_data/flink-cdc/" class="nav-link">
  Flink CDC
</a></li><li class="dropdown-item"><!----> <a href="/big_data/hadoop/" class="nav-link">
  Hadoop
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/databases/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/databases/redis/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="环境搭建" class="dropdown-title"><span class="title">环境搭建</span> <span class="arrow down"></span></button> <button type="button" aria-label="环境搭建" class="mobile-dropdown-title"><span class="title">环境搭建</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/env_build/blog_vuepress/" class="nav-link">
  博客by-vuepress
</a></li><li class="dropdown-item"><!----> <a href="/env_build/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/env_build/linux/" class="nav-link">
  linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="记录" class="dropdown-title"><span class="title">记录</span> <span class="arrow down"></span></button> <button type="button" aria-label="记录" class="mobile-dropdown-title"><span class="title">记录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/take_notes/interview/" class="nav-link">
  面试
</a></li><li class="dropdown-item"><!----> <a href="/take_notes/essay/" class="nav-link">
  优秀文章
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>数据库</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/databases/mysql/" class="sidebar-heading clickable open"><span>MySQL</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/databases/mysql/一条数据的写入流程.html" class="sidebar-link">一条数据是如何写入的</a></li><li><a href="/databases/mysql/隔离级别.html" class="sidebar-link">隔离级别</a></li></ul></section></li><li><a href="/databases/redis/" aria-current="page" class="active sidebar-link">Redis</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="redis"><a href="#redis" class="header-anchor">#</a> Redis</h1> <p>Redis是当下最流行的NoSQL数据库之一，可以应用于数据库，缓存和消息队列等场景。具有较多优点：</p> <ol><li>性能极高</li> <li>数据类型丰富，单键值对最大支持512M大小的数据</li> <li>简单易用，支持几乎所有的主流编程语言</li> <li>支持持久化，支持主从、哨兵和Cluster等高可用模式</li></ol> <h2 id="一、数据类型"><a href="#一、数据类型" class="header-anchor">#</a> 一、数据类型</h2> <h3 id="基础数据类型"><a href="#基础数据类型" class="header-anchor">#</a> 基础数据类型</h3> <ol><li>String</li> <li>Hash</li> <li>List</li> <li>Set</li> <li>ZSet</li></ol> <h3 id="高级数据类型"><a href="#高级数据类型" class="header-anchor">#</a> 高级数据类型</h3> <ol><li>消息队列 Stream</li> <li>地理空间 GeoSpatial</li> <li>HyperLogLog</li> <li>位图 Bitmap</li> <li>位域 BitField</li></ol> <h2 id="二、持久化"><a href="#二、持久化" class="header-anchor">#</a> 二、持久化</h2> <p>Redis数据存储在内存中，如果服务器宕机，内存中的数据将会丢失，对于一个数据库而言是非常致命的。所以Redis官方提供了两种数据持久化的方式</p> <h3 id="rdb-redis-database"><a href="#rdb-redis-database" class="header-anchor">#</a> RDB (Redis Database)</h3> <p>在指定的间隔时间内，将内存中的数据快照写入磁盘，是某个时间点上数据的完整副本，通过配置文件中的save参数配置，表示规定时间内有多少次数据修改就进行一次快照存储</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>save &lt;seconds&gt; &lt;changes&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>RDB 存在的问题：</p> <ol><li>如果服务器宕机，最后一次的快照数据就会丢失。</li> <li>快照会存储当前内存中的所有数据，每次生成快照所需时间太久，在生成快照这段时间内Redis是一个阻塞的状态，不能接收请求。 所以Redis提供了bgsave命令，这个命令会fork子进程来进行快照生成，不会影响客户端。</li></ol> <h3 id="aof-append-only-file"><a href="#aof-append-only-file" class="header-anchor">#</a> AOF (Append-Only File)</h3> <p>AOF是以日志追加的形式存储数据的，在写入数据时，即写入内存，也会写入追加文件，写入策略分为如下几种：</p> <ol><li>always:每次写入数据都写aof文件，性能最差，但是最安全。</li> <li>EverySec: 每秒追加一次，是一种平衡的方案，可能会丢失一秒钟的数据。</li> <li>No: 数据写入内存后结束，由操作系统决定何时追加到aof文件，最不安全。</li></ol> <h4 id="aof重写"><a href="#aof重写" class="header-anchor">#</a> AOF重写</h4> <p>随着数据不断写入，并且一些key会多次重复操作，导致AOF文件会越来越大，写入速度也会越来越慢，使用该文件进行数据恢复时，速度会很慢。</p> <p>所以Redis官方推出AOF重写机制，在子进程中生成一个新的AOF文件，只将当前有效数据进行追加写入，比如某个key1，对其进行了1W次的修改，那么新的AOF文件值存储最新的一次修改记录即可。这种方式可以有效的降低文件大小。</p> <h2 id="三、集群模式"><a href="#三、集群模式" class="header-anchor">#</a> 三、集群模式</h2> <h3 id="主从模式"><a href="#主从模式" class="header-anchor">#</a> 主从模式</h3> <p>由多个节点构成，包括一个主节点Master和一个或多个从节点Slave，Master节点负责读写，Slave节点负责读。</p> <p>主从模式比较大的问题在于当Master节点宕机后，整个集群无法提供写的服务，需要手动将某个Slave节点切换为Master节点才能继续提供服务，无法提供真正的高可用。</p> <h3 id="哨兵模式"><a href="#哨兵模式" class="header-anchor">#</a> 哨兵模式</h3> <p>哨兵模式很好的解决了主从模式的问题，在该模式下，会有单独的哨兵进程存在于Redis集群中。哨兵具有以下两个功能：</p> <ol><li>监控：监控各个Redis节点状态是否正常</li> <li>通知：如果某个主节点出现问题，哨兵会通过发布/订阅模式通知其他哨兵</li> <li>故障转移：通知其他哨兵后，会进行下线、重新选主的流程，选举出新的Master节点。</li></ol> <h4 id="哨兵模式下的主从切换过程"><a href="#哨兵模式下的主从切换过程" class="header-anchor">#</a> 哨兵模式下的主从切换过程</h4> <ol><li><strong>监控</strong>
sentinal每隔1s向各个节点发送ping命令，持续的监控master节点的状态</li> <li><strong>下线（主观下线、客观下线）</strong>
如果sentinal发送的ping命令在规定的时间内没有相应，则sentinal会将这个节点标记为主观下线；
这个时候当前sentinal会告知其他哨兵节点，其他哨兵会确认与master的连接情况，如果超过半数的sentinal都认为master节点无法提供服务，那么master节点就进入客观下线状态</li> <li><strong>选主</strong>
master进入客观下线状态后，开始选主任务；
选主时会先对从节点进行过滤，过滤掉没有连接的，或者网络不稳定的从节点之后进入打分阶段；
打分时根据由高到低的优先级： 从库的优先级、从库数据复制进度、从库id号（从低到高排），计算出的分数最高的从节点获胜，升级为主节点</li></ol> <h3 id="cluster模式"><a href="#cluster模式" class="header-anchor">#</a> Cluster模式</h3> <h2 id="redis的事物"><a href="#redis的事物" class="header-anchor">#</a> Redis的事物</h2> <p>Redis的事物是在一次请求中执行多个命令，使用<code>MULTI</code>和<code>EXEC/DISCARD</code>实现。MULTI用来开启事物，开启后，后序所有的命令都会放到一个队列中，最后通过EXEC命令来执行队列中的所有命令，用DISCARD命令来取消命令。</p> <p>Redis中的事物和我们常见的关系型数据库的事物不太一样，Redis事物中的命令不会因为某个命令执行失败而导致所有命令都失败，如果某一个命令执行失败了，那么其他命令也会继续执行，不会受到影响。</p> <h2 id="一、基于内存实现"><a href="#一、基于内存实现" class="header-anchor">#</a> 一、基于内存实现</h2> <div class="language- extra-class"><pre><code>内存读写速度远高于磁盘，内存的响应时间约为100纳秒。
</code></pre></div><h2 id="二、数据结构"><a href="#二、数据结构" class="header-anchor">#</a> 二、数据结构</h2> <h3 id="_1-字符串-sds-简单动态字符串"><a href="#_1-字符串-sds-简单动态字符串" class="header-anchor">#</a> 1. 字符串（SDS-简单动态字符串）</h3> <p>SDS的结构：</p> <p>char[] buff; //字符数组</p> <p>int len; //字符串长度</p> <p>int free; //buff字段中没有使用的长度</p> <p><img src="/images/redis/redis%E5%AD%98%E5%82%A8%E5%AD%97%E7%AC%A6%E4%B8%B2.png" alt="redis存储字符串"></p> <ul><li><p>优势：</p> <p><strong>长度计算</strong>：Redis可以直接调用获取长度的方法（strlen）。</p> <p><strong>字符串变更操作</strong>：因为他的内存分配和释放策略，可以高效的对字符串进行追加和缩短。</p> <ul><li>空间预分配：</li></ul> <p>小于1M的字符串，分配时为原长+等长+1字节。如某字符串长度=5，初始分配长度=5+5+1=11；</p> <p>大于1M的字符串，分配时为原长+1M+1字节，如某字符串初始大小为3M，则分配内存=3M+1M+1Byte；</p> <ul><li>空间惰性释放：</li></ul> <p>上图的redis，变成red，内存无需释放，len-&gt;3, free-&gt;7；</p></li></ul> <h3 id="_2-链表-双向无环链表-list-listnode"><a href="#_2-链表-双向无环链表-list-listnode" class="header-anchor">#</a> 2. 链表（双向无环链表 list+listNode）</h3> <p><img src="/images/redis/redis%E9%93%BE%E8%A1%A8%E7%BB%93%E6%9E%84.jpeg" alt="redis链表结构"></p> <p>优势：</p> <ul><li>双向</li> <li>无环</li> <li>list中明确了表头，表尾以及长度</li></ul> <h3 id="_3-压缩列表-ziplist"><a href="#_3-压缩列表-ziplist" class="header-anchor">#</a> 3. 压缩列表（ziplist）</h3> <ul><li>连续的内存空间</li> <li>给每个节点增加一个length属性</li></ul> <p>简单压缩列表：</p> <p><img src="/images/redis/%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A81.png" alt="压缩列表"></p> <p>Redis压缩列表结构示例：</p> <p><img src="/images/redis/redis%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E7%BB%93%E6%9E%84%E7%A4%BA%E4%BE%8B.png" alt="redis压缩列表结构示例"></p> <p>entry说明：</p> <p><b>prevlength（8位）</b>：上一个节点的长度（方便反向遍历）。</p> <p>​	当prevlength&lt;254时，该值就代表上一个节点的真实长度；</p> <p>​	当prevlength&gt;=254时，该节点的前8位无法表示真实长度，从第8位开始的后面32位才是上一个节点的长度。</p> <p><b>encoding</b>：指当前节点的编码规则</p> <p><b>data</b>：当前节点值</p> <h3 id="_4-字典-哈希表"><a href="#_4-字典-哈希表" class="header-anchor">#</a> 4. 字典（哈希表）</h3> <p>基于散列，但因为散列函数会出现散列冲突，解决散列冲突的两种方法：开放寻址法和链表法</p> <p>Redis的实现：</p> <p><img src="/images/redis/redis%E5%AD%97%E5%85%B8.jpeg" alt="redis字典.jpeg"></p> <h4 id="_5-跳跃表-多级索引"><a href="#_5-跳跃表-多级索引" class="header-anchor">#</a> 5. 跳跃表（多级索引）</h4> <p>什么是跳跃表？</p> <p><img src="/images/redis/%E4%B8%80%E5%B1%82%E8%B7%B3%E8%B7%83%E8%A1%A8.png" alt="一层跳跃表.png"></p> <p>redis的跳跃表是有序集合（zSet）的其中一个实现，如果有序集合的元素大于128个或者集合中元素长度大于64，就会使用跳跃表，否则使用压缩列表。</p> <p>**redis跳跃表的实现：**skipList + zskipListNode</p> <p><img src="/images/redis/Redis%E8%B7%B3%E8%B7%83%E8%A1%A8.png" alt="redis跳跃表.png"></p> <p>蓝色指skipList，右边部分是多个zskipListNode</p> <p>skipList结构：</p> <ul><li><p>header：指向第一个zskipListNode</p></li> <li><p>tail：指向最后一个zskipListNode</p></li> <li><p>level：当前跳跃表中层数最大的zskipListNode（头节点不算在内）</p></li> <li><p>length：当前跳跃表的长度，即zskipListNode的数量（头节点不算在内）</p></li></ul> <p>zskiplistNode结构：</p> <ul><li>level：层，L1代表第一层，L2代表第二层。每一个level都有两个属性，一个是前进指针，一个是跨度。</li> <li>backward（后退）：当前zskiplistNode的前一个节点</li> <li>score：排序使用</li> <li>对象：各节点保存的成员对象的指针，指向实际保存的地址。</li></ul> <h2 id="三、线程模型"><a href="#三、线程模型" class="header-anchor">#</a> 三、线程模型</h2> <h3 id="_1-文件事件处理器"><a href="#_1-文件事件处理器" class="header-anchor">#</a> 1. <strong>文件事件处理器</strong></h3> <p><img src="/images/redis/%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%99%A8.png" alt="文件事件处理器.png"></p> <ul><li><p>套接字（socket）</p> <p>客户端连接、读写等操作请求，server socket根据这些请求产生文件事件，文件事件包括AE_READABLE，AE_WRITABLE，redis服务端可读，可连接产生的是AE_READABLE，可写产生的是AE_WRITABLE事件。</p></li> <li><p>I/O多路复用程序</p> <p>作用是用来监听server socket，并将这些socket顺序的放入队列中。</p></li> <li><p>文件事件分派器</p> <p>接收队列中的socket，并将socket中的文件事件类型与对应的事件处理器关联，根据对应的事件处理器进行操作。</p></li> <li><p>事件处理器</p> <ul><li>连接应答处理器：redis服务器初始化时，关联服务器监听套接字产生的AE_READABLE事件。事件在客户端connect时产生，创建套接字。</li> <li>命令请求处理器：客户端连接成功后，关联客户端套接字的AE_READABLE事件。</li> <li>命令回复处理器：服务器有命令回复需要传送给客户端时，关联客户端套接字的AE_WRITABLE事件。事件在客户端尝试读取时产生。</li></ul></li></ul> <p><strong>完整通信过程：</strong></p> <p><img src="/images/redis/%E9%80%9A%E4%BF%A1%E8%BF%87%E7%A8%8B.png" alt="通信过程"></p> <h3 id="_2-时间事件处理器"><a href="#_2-时间事件处理器" class="header-anchor">#</a> 2.时间事件处理器</h3> <ul><li>刷新服务器信息</li> <li>清理过期的key</li> <li>持久化</li></ul> <p><strong>为什么说Redis是单线程实现的？</strong></p> <p>-- redis内部使用文件事件处理器（file event handler），因为文件事件处理器在执行redis命令请求时是单线程执行的，而文件事件处理器是redis的核心，所以说redis是单线程的。</p> <p>实际上redis从4.0版本开始，删除对象的操作也开始使用多线程处理。</p> <h2 id="redis热key问题"><a href="#redis热key问题" class="header-anchor">#</a> Redis热key问题</h2> <h3 id="一、什么是热key"><a href="#一、什么是热key" class="header-anchor">#</a> 一、什么是热key</h3> <p>瞬间有大量请求去访问redis上某个固定的key，导致redis服务器宕机。某些业务下如果redis服务不可用，则会请求数据库，导致数据库服务无法使用。</p> <h3 id="二、如何解决"><a href="#二、如何解决" class="header-anchor">#</a> 二、如何解决</h3> <h4 id="_1-监控"><a href="#_1-监控" class="header-anchor">#</a> 1. 监控</h4> <ul><li>客户端收集：在调用redis服务的时候，增加一层监控，对所有rediskey进行ump监控。</li> <li>redis服务集群代理：在redis服务器集群上做一层代理，所有请求经过这个代理，从而通过这个代理进行统一监控</li> <li>redis自带命令：
<ul><li>monitor命令-可实时抓取redis服务器接收到的命令，需要单独开发统计的逻辑代码。</li> <li>hotkeys参数-4.0.3版本以后加入，需要在客户端启动时增加-hotkeys参数。key比较多的情况下执行速度很慢。</li></ul></li></ul> <h4 id="_2-解决方案"><a href="#_2-解决方案" class="header-anchor">#</a> 2. 解决方案：</h4> <p><strong>客户端缓存：</strong></p> <p>redis服务器发现热key后，通过sdk把热key写入到客户端的本地缓存中，当key发生了写操作的时候，再把这个key从本地缓存中删除。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/databases/mysql/隔离级别.html" class="prev">
        隔离级别
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.550bb993.js" defer></script><script src="/assets/js/2.90409a71.js" defer></script><script src="/assets/js/16.4c8c8826.js" defer></script>
  </body>
</html>
