"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createHookQueue = void 0;
const shared_1 = require("@vuepress/shared");
const utils_1 = require("@vuepress/utils");
const log = utils_1.debug('vuepress:core/plugin-api');
/**
 * Create hook queue for plugin system
 */
const createHookQueue = (name, parallel = false) => {
    const items = [];
    const hookQueue = {
        // hook name
        name,
        // hook items array
        items,
        // add hook item to queue
        add: (item) => {
            items.push(item);
        },
        // process the hook queue and get the results
        process: async (...args) => {
            // store the results of all hook items
            const results = [];
            // process a hook item and store the result
            const processItem = async (item, ...args) => {
                log(`process ${utils_1.chalk.magenta(name)} from ${utils_1.chalk.magenta(item.pluginName)}`);
                try {
                    // process and get the result of the the hook item
                    // @ts-ignore
                    const result = (await item.hook(...args));
                    // push the result to results array
                    if (result !== undefined) {
                        results.push(result);
                    }
                }
                catch (error) {
                    utils_1.logger.error(`error in hook ${utils_1.chalk.magenta(name)} from ${utils_1.chalk.magenta(item.pluginName)}`);
                    throw error;
                }
            };
            // process all hook items in current queue
            if (parallel) {
                // process in parallel
                await Promise.all(items.map((item) => processItem(item, ...args)));
            }
            else {
                // process in serial
                for (const item of items) {
                    await processItem(item, ...args);
                }
            }
            return results;
        },
        // process the hook queue and get the results
        processSync: (...args) => {
            // store the results of all hook items
            const results = [];
            // process all hook items
            for (const item of items) {
                log(`processSync ${utils_1.chalk.magenta(name)} from ${utils_1.chalk.magenta(item.pluginName)}`);
                try {
                    // @ts-ignore
                    // process and get the result of the the hook item
                    const result = item.hook(...args);
                    // push the result to results array
                    if (result !== undefined && !shared_1.isPromise(result)) {
                        results.push(result);
                    }
                }
                catch (error) {
                    utils_1.logger.error(`error in hook ${utils_1.chalk.magenta(name)} from ${utils_1.chalk.magenta(item.pluginName)}`);
                    throw error;
                }
            }
            return results;
        },
    };
    return hookQueue;
};
exports.createHookQueue = createHookQueue;
